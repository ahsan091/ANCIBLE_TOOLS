# OpenCTI Docker Compose Override
# Generated by Ansible - Do not edit manually
# Attaches services to BOTH default and soc_net networks
# Disables connector-history to prevent missing image error

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Core Services - attached to both networks
  # ─────────────────────────────────────────────────────────────────────────
  redis:
    networks:
      - default
      - {{ soc_network_name }}

  elasticsearch:
    networks:
      - default
      - {{ soc_network_name }}

  minio:
    ports:
      - "{{ opencti_minio_api_host_port | default(9200) }}:9000"
      - "{{ opencti_minio_console_host_port | default(9201) }}:9001"
    networks:
      - default
      - {{ soc_network_name }}


  rabbitmq:
    networks:
      - default
      - {{ soc_network_name }}

  # OpenCTI main service - MUST be on both networks
  opencti:
    ports:
      - "{{ opencti_web_port | default(8091) }}:8080"
    networks:
      - default
      - {{ soc_network_name }}

  worker:
    networks:
      - default
      - {{ soc_network_name }}

  # ─────────────────────────────────────────────────────────────────────────
  # Connectors - attached to both networks
  # connector-history is replaced with a stub to prevent missing image error
  # ─────────────────────────────────────────────────────────────────────────
  connector-history:
    image: alpine:3.20
    command: ["sh", "-c", "echo 'connector-history disabled by Ansible' && sleep infinity"]
    restart: unless-stopped
    networks:
      - default
      - {{ soc_network_name }}

  connector-export-file-stix:
    networks:
      - default
      - {{ soc_network_name }}

  connector-export-file-csv:
    networks:
      - default
      - {{ soc_network_name }}

  connector-export-file-txt:
    networks:
      - default
      - {{ soc_network_name }}

  connector-import-file-stix:
    networks:
      - default
      - {{ soc_network_name }}

  connector-import-document:
    networks:
      - default
      - {{ soc_network_name }}

  connector-analysis:
    networks:
      - default
      - {{ soc_network_name }}

# ─────────────────────────────────────────────────────────────────────────
# Networks configuration
# ─────────────────────────────────────────────────────────────────────────
networks:
  default:
    driver: bridge
  {{ soc_network_name }}:
    external: true
    name: {{ soc_network_name }}
