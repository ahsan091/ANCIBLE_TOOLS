---
# ============================================================================
# Role: shuffle
# Purpose: Deploy Shuffle (Security Orchestration and Automation Platform)
# ============================================================================

- name: Create Shuffle installation directory
  ansible.builtin.file:
    path: "{{ shuffle_install_dir }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'

- name: Check if Shuffle repository exists
  ansible.builtin.stat:
    path: "{{ shuffle_install_dir }}/.git"
  register: shuffle_repo

- name: Clone Shuffle repository
  ansible.builtin.git:
    repo: https://github.com/Shuffle/Shuffle.git
    dest: "{{ shuffle_install_dir }}"
    version: "{{ shuffle_git_ref }}"
    force: false
  become_user: "{{ target_user }}"
  when: not shuffle_repo.stat.exists

- name: Reset local modifications before updating Shuffle repository
  ansible.builtin.shell: |
    cd {{ shuffle_install_dir }}
    git reset --hard HEAD
    git clean -fd
  become_user: "{{ target_user }}"
  when: shuffle_repo.stat.exists
  ignore_errors: true

- name: Update Shuffle repository
  ansible.builtin.git:
    repo: https://github.com/Shuffle/Shuffle.git
    dest: "{{ shuffle_install_dir }}"
    version: "{{ shuffle_git_ref }}"
    update: true
    force: false
  become_user: "{{ target_user }}"
  when: shuffle_repo.stat.exists
  register: git_update

- name: Create shuffle-database directory
  ansible.builtin.file:
    path: "{{ shuffle_install_dir }}/shuffle-database"
    state: directory
    owner: "1000"
    group: "1000"
    mode: '0755'

- name: Create Shuffle .env file
  ansible.builtin.template:
    src: env.j2
    dest: "{{ shuffle_install_dir }}/.env"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0600'

- name: Create Shuffle docker-compose.override.yml
  ansible.builtin.template:
    src: docker-compose.override.yml.j2
    dest: "{{ shuffle_install_dir }}/docker-compose.override.yml"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'

- name: Remove invalid bind options from named volumes (Shuffle-specific fix)
  ansible.builtin.shell: |
    cd {{ shuffle_install_dir }}
    if command -v yq >/dev/null 2>&1; then
      for service in $(yq eval '.services | keys | .[]' docker-compose.yml 2>/dev/null); do
        volumes_count=$(yq eval ".services.$service.volumes | length" docker-compose.yml 2>/dev/null || echo 0)
        for ((i=0; i<volumes_count; i++)); do
          volume_type=$(yq eval ".services.$service.volumes[$i].type" docker-compose.yml 2>/dev/null)
          if [[ "$volume_type" == "volume" ]]; then
            yq eval -i "del(.services.$service.volumes[$i].bind)" docker-compose.yml 2>/dev/null || true
          fi
        done
      done
    fi
  args:
    executable: /bin/bash
  changed_when: false
  ignore_errors: true

- name: Remove ports section from opensearch service and obsolete version field (fixes YAML structure and port conflict)
  ansible.builtin.shell: |
    cd {{ shuffle_install_dir }}
    python3 -c "
    import yaml
    with open('docker-compose.yml', 'r') as f:
        data = yaml.safe_load(f) or {}
    # Remove ports from opensearch service if it exists
    if 'services' in data and 'opensearch' in data.get('services', {}):
        data['services']['opensearch'].pop('ports', None)
    # Remove obsolete version field (Docker Compose v2 doesn't need it)
    if 'version' in data:
        del data['version']
    with open('docker-compose.yml', 'w') as f:
        yaml.dump(data, f, default_flow_style=False, sort_keys=False, allow_unicode=True)
    "
  args:
    executable: /bin/bash
  changed_when: true
  failed_when: false
  ignore_errors: true

- name: Stop and remove existing opensearch container if it exists (to fix port conflict)
  ansible.builtin.command:
    cmd: docker stop shuffle-opensearch && docker rm shuffle-opensearch
    chdir: "{{ shuffle_install_dir }}"
  register: cleanup_opensearch
  changed_when: cleanup_opensearch.rc == 0
  failed_when: false
  ignore_errors: true

- name: Deploy Shuffle stack
  community.docker.docker_compose_v2:
    project_src: "{{ shuffle_install_dir }}"
    state: present
    pull: missing
    build: policy
  register: shuffle_compose

- name: Wait for Shuffle frontend to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ shuffle_frontend_http_port }}"
    method: GET
    return_content: true
    status_code: [200, 302, 503, 502]
  register: shuffle_health
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  until: shuffle_health.status in [200, 302]
  ignore_errors: true

- name: Display Shuffle deployment status
  ansible.builtin.debug:
    msg: |
      ‚úÖ Shuffle deployed successfully!
      üìç Directory: {{ shuffle_install_dir }}
      üåê HTTP URL: http://localhost:{{ shuffle_frontend_http_port }}
      üîí HTTPS URL: https://localhost:{{ shuffle_frontend_https_port }}
      üîß Backend API: http://localhost:{{ shuffle_backend_port }}
      
      ‚ö†Ô∏è  IMPORTANT: First-time setup required!
      Navigate to: http://localhost:{{ shuffle_frontend_http_port }}/adminsetup
      to create your admin account.
