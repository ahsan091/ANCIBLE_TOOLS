---
# ============================================================================
# Role: common
# Purpose: Install system prerequisites and configure kernel parameters
# ============================================================================

- name: Gather package facts
  ansible.builtin.package_facts:
    manager: apt

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install prerequisite packages
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - git
      - jq
      - iproute2
      - net-tools
      - python3-pip
      - python3-docker
      - apt-transport-https
      - software-properties-common
    state: present
    update_cache: true
  register: prereq_result
  retries: 3
  delay: 5
  until: prereq_result is succeeded

- name: Install yq (mikefarah) if missing
  ansible.builtin.shell: |
    set -e
    if command -v yq >/dev/null 2>&1; then exit 0; fi
    arch="$(uname -m)"
    case "$arch" in
      x86_64|amd64) url="https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64" ;;
      aarch64|arm64) url="https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_arm64" ;;
      *) url="https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64" ;;
    esac
    curl -fsSL "$url" -o /usr/local/bin/yq
    chmod +x /usr/local/bin/yq
  args:
    executable: /bin/bash
  changed_when: true

- name: Install Python docker SDK (required for docker_compose_v2)
  ansible.builtin.pip:
    name:
      - docker>=6.0.0
      - docker-compose
    state: present
  become: true

- name: Set vm.max_map_count for Elasticsearch/OpenSearch
  ansible.posix.sysctl:
    name: vm.max_map_count
    value: "{{ sysctl_max_map_count | default(1048575) }}"
    state: present
    reload: true
    sysctl_file: /etc/sysctl.d/99-socstack.conf

- name: Ensure sysctl settings are applied
  ansible.builtin.command: sysctl --system
  changed_when: false

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone | default('UTC') }}"
  when: timezone is defined or timezone | default('') != ''

- name: Display common role completion
  ansible.builtin.debug:
    msg: "âœ… System prerequisites installed and configured"
